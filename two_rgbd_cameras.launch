<launch>
    <!-- Start RealSense R200 cameras -->
    <!-- Number of cameras -->
    <arg name="num_of_cameras"        default="2"/>

    <!-- Frames: RealSense R200 are placed at 60 degrees, counterclockwise -->
    <node pkg="tf" type="static_transform_publisher" name="base_to_camera_forward_tf"
        args="0.0 0.0 0.0 0.0 0.0 0.0 /base_link /camera_forward_link 100"/>
    <node pkg="tf" type="static_transform_publisher" name="base_to_camera_backward_tf"
        args="-0.05 -0.1 0.0 -1.0472 0.0 0.0 /base_link /camera_backward_link 100"/>

    <!-- Choose visualization -->
    <arg name="rtabmapviz"            default="false"/>
    <arg name="rviz"                  default="true"/>

    <!-- Localization-only mode -->
    <arg name="localization"          default="false"/>

    <!-- Corresponding config files -->
    <arg name="cfg"                   default=""/> <!-- To change RTAB-Map's parameters, set the path of config file (*.ini) generated by the standalone app -->
    <arg name="gui_cfg"               default="~/.ros/rtabmap_gui.ini"/>
    <arg name="rviz_cfg"              default="$(find rtabmap_ros)/launch/config/rgbd.rviz"/>

    <arg name="frame_id"              default="base_link"/>   <!-- Fixed frame id, you may set "camera_link" or "base_footprint" if they are published -->
    <arg name="queue_size"            default="20"/>
    <arg name="wait_for_transform"    default="0.2"/>
    <arg name="args"                  default=""/>            <!-- delete_db_on_start, udebug -->
    <arg name="rtabmap_args"          default="$(arg args)"/> <!-- deprecated, use "args" argument -->
    <arg name="launch_prefix"         default=""/> <!-- for debugging purpose, it fills launch-prefix tag of the nodes -->
    <arg name="output"                default="screen"/>      <!--Control node output (screen or log)-->

    <!-- RGB-D related topics -->
    <arg name="rgb_topic"             default="color/image_raw"/>
    <arg name="depth_topic"           default="aligned_depth_to_color/image_raw"/>
    <arg name="camera_info_topic"     default="color/camera_info"/>

    <!-- stereo related topics -->
    <arg name="visual_odometry"       default="true"/> <!-- Launch rtabmap visual odometry node -->

    <!-- Odometry main arguments -->
    <arg name="strategy"              default="0"/>    <!-- Strategy: 0=Frame-to-Map (F2M), 1=Frame-to-Frame (F2F) -->
    <arg name="feature"               default="6"/>    <!-- Feature type: 0=SURF, 1=SIFT, 2=ORB, 3=FAST/FREAK, 4=FAST/BRIEF, 5=GFTT/FREAK, 6=GFTT/BRIEF, 7=BRISK, 8=GFTT/ORB -->
    <arg name="nn"                    default="1"/>    <!-- Nearest neighbor strategy: 0=Linear, 1=FLANN_KDTREE, 2=FLANN_LSH, 3=BRUTEFORCE, 4=BRUTEFORCEGPU -->
    <arg name="max_depth"             default="0"/>    <!-- Maximum features depth (m) (0 means no limit) -->
    <arg name="min_inliers"           default="20"/>   <!-- Minimum visual correspondences to accept a transformation (m) -->
    <arg name="inlier_distance"       default="0.01"/> <!-- Maximum distance for feature correspondences. Used by 3D->3D estimation approach. -->
    <arg name="local_map"             default="2000"/> <!-- Local map size: number of unique features to keep track. If > 0 (example 5000), the odometry will maintain a local map of X maximum words -->
    <arg name="odom_info_data"        default="true"/> <!-- Fill odometry info messages with inliers/outliers data -->

    <!-- sync rgb/depth images per camera -->
    <group ns="camera_forward">
        <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="load rtabmap_ros/rgbd_sync camera_forward_nodelet_manager">
            <remap from="rgb/image"       to="$(arg rgb_topic)"/>
            <remap from="depth/image"     to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <param name="approx_sync"     value="false"/>
        </node>
    </group>
    <group ns="camera_backward">
        <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="load rtabmap_ros/rgbd_sync camera_backward_nodelet_manager">
            <remap from="rgb/image"       to="$(arg rgb_topic)"/>
            <remap from="depth/image"     to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <param name="approx_sync"     value="false"/>
        </node>
    </group>

    <group ns="rtabmap">

        <!-- RGB-D Odometry -->
        <node if="$(arg visual_odometry)" pkg="rtabmap_ros" type="rgbd_odometry" name="rgbd_odometry" output="$(arg output)" launch-prefix="$(arg launch_prefix)">
            <remap from="rgbd_image0"       to="/camera_forward/rgbd_image"/>
            <remap from="rgbd_image1"       to="/camera_backward/rgbd_image"/>

            <param name="subscribe_rgbd"              type="bool"    value="true"/>
            <param name="frame_id"                    type="string"  value="$(arg frame_id)"/>
            <param name="rgbd_cameras"                type="int"     value="$(arg num_of_cameras)"/>
            <param name="wait_for_transform_duration" type="double"  value="$(arg wait_for_transform)"/>
            <param name="queue_size"                  type="int"     value="$(arg queue_size)"/>

            <param name="Odom/Strategy"               type="string"  value="$(arg strategy)"/>
            <param name="Vis/FeatureType"             type="string"  value="$(arg feature)"/>
            <param name="Vis/CorNNType"               type="string"  value="$(arg nn)"/>
            <param name="Vis/MaxDepth"                type="string"  value="$(arg max_depth)"/>
            <param name="Vis/MinInliers"              type="string"  value="$(arg min_inliers)"/>
            <param name="Vis/InlierDistance"          type="string"  value="$(arg inlier_distance)"/>
            <param name="OdomF2M/MaxSize"             type="string"  value="$(arg local_map)"/>
            <param name="Odom/FillInfoData"           type="string"  value="$(arg odom_info_data)"/>
        </node>

        <!-- Visual SLAM (robot side) -->
        <!-- args: "delete_db_on_start" and "udebug" -->
        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="$(arg output)" args="$(arg rtabmap_args)" launch-prefix="$(arg launch_prefix)">
            <param name="subscribe_depth"             type="bool"   value="false"/>
            <param name="subscribe_rgbd"              type="bool"   value="true"/>
            <param name="rgbd_cameras"                type="int"    value="$(arg num_of_cameras)"/>
            <param name="frame_id"                    type="string" value="$(arg frame_id)"/>
            <param name="gen_scan"                    type="bool"   value="true"/>
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>
            <param name="map_negative_poses_ignored"  type="bool"   value="false"/>       <!-- refresh grid map even if we are not moving-->
            <param name="map_negative_scan_empty_ray_tracing" type="bool" value="false"/> <!-- don't fill empty space between the generated scans-->
            <param name="queue_size"                  type="int"    value="$(arg queue_size)"/>

            <remap from="rgbd_image0"       to="/camera_forward/rgbd_image"/>
            <remap from="rgbd_image1"       to="/camera_backward/rgbd_image"/>

            <param name="Grid/FromDepth"     type="string" value="false"/>
            <param name="Vis/MinInliers"     type="string" value="20"/>
            <param name="Vis/InlierDistance" type="string" value="$(arg inlier_distance)"/>

            <!-- localization mode -->
            <!-- <param     if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
            <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)"/> -->
        </node>

        <!-- Visualisation RTAB-Map -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="-d $(arg gui_cfg)" output="$(arg output)" launch-prefix="$(arg launch_prefix)">
            <param name="subscribe_depth"     type="bool"   value="false"/>
            <param name="subscribe_rgbd"      type="bool"   value="true"/>
            <param name="subscribe_odom_info" type="bool"   value="$(arg odom_info_data)"/>
            <param name="frame_id"            type="string" value="$(arg frame_id)"/>
            <param name="rgbd_cameras"        type="int"    value="$(arg num_of_cameras)"/>
            <param name="wait_for_transform_duration"  type="double"   value="$(arg wait_for_transform)"/>
            <param name="queue_size"          type="int"    value="$(arg queue_size)"/>

            <remap from="rgbd_image0"       to="/camera_forward/rgbd_image"/>
            <remap from="rgbd_image1"       to="/camera_backward/rgbd_image"/>
        </node>

    </group>

    <!-- Visualization RVIZ -->
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)"/>

</launch>
